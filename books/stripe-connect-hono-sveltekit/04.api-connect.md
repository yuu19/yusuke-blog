---
title: Hono APIでConnect AccountとCheckoutを実装
---

# Hono APIでConnect AccountとCheckoutを実装

この章では `apps/api` に Stripe Connect の中核ロジックを実装します。

章対応コミット:

- API実装: https://github.com/yuu19/stripe-connect-hono-sveltekit-demo/commit/12b91ceaf124441f8bdc5b6ef3237f46212d9d4e

## 実装エンドポイント

- `POST /internal/connect/account`
- `POST /internal/connect/account-link`
- `POST /internal/checkout/session`
- `POST /webhooks/stripe`
- `GET /healthz`

## 内部API保護

`/internal/*` は `x-internal-token` を必須化します。

```ts
app.use('/internal/*', async (c, next) => {
  const token = c.req.header('x-internal-token');
  if (!token || token !== c.env.INTERNAL_API_TOKEN) {
    throw new HTTPException(401, { message: 'Unauthorized internal call' });
  }
  await next();
});
```

## destination charge の核心

Checkout Session 作成時に次を設定します。

- `payment_intent_data.application_fee_amount`
- `payment_intent_data.transfer_data.destination`

```ts
payment_intent_data: {
  application_fee_amount: applicationFeeAmount,
  transfer_data: {
    destination: seller.stripeAccountId
  }
}
```

この2つが入っていないと、platform fee と送金先が期待どおりになりません。
