---
title: Webhook設計(署名検証・重複排除)とテスト
---

# Webhook設計(署名検証・重複排除)とテスト

この章では、事故りやすい Webhook の守りを固めます。

章対応コミット:

- API + テスト: https://github.com/yuu19/stripe-connect-hono-sveltekit-demo/commit/12b91ceaf124441f8bdc5b6ef3237f46212d9d4e

## 署名検証

`stripe.webhooks.constructEventAsync` で署名検証し、失敗時は 400 を返します。

## 重複排除

- まず `hasStripeEvent(event.id)` で既処理判定
- 未処理なら `recordStripeEvent` で受信記録
- 処理完了後 `markStripeEventProcessed`

## イベント別更新

- `checkout.session.completed` -> `checkout_order` を `paid`
- `checkout.session.expired` -> `expired`
- `checkout.session.async_payment_failed` -> `failed`

## テストケース

`apps/api/test/api.test.ts` で以下を検証しています。

1. internal token欠落は401
2. Checkout Sessionに `application_fee_amount` と `transfer_data.destination` が入る
3. Webhook署名なし/不正は400
4. 同一event再送は `duplicate: true`
5. 正常受信時に注文状態更新 + event処理完了記録
